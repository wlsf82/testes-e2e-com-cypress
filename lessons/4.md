# Testando um CRUD

Ok, agora que garantimos que o(a) usuÃ¡rio(a) pode se registrar e se autenticar na aplicaÃ§Ã£o **Scratch**, Ã© hora de testar sua funcionalidade principal.

## ExercÃ­cio

1. No diretÃ³rio `cypress/integration/`, crie um arquivo chamado `crud.spec.js` com o seguinte conteÃºdo:

```js
// cypress/integration/crud.spec.js

it('CRUDs a note', () => {
  const faker = require('faker')
  const noteDescription = faker.lorem.words(4)

  cy.intercept('GET', '**/notes').as('getNotes')
  cy.intercept('GET', '**/notes/**').as('getNote')
  cy.login()

  cy.visit('/notes/new')
  cy.get('#content').type(noteDescription)
  cy.contains('button', 'Create').click()

  cy.wait('@getNotes')
  cy.contains('.list-group-item', noteDescription)
    .should('be.visible')
    .click()
  cy.wait('@getNote')

  const updatedNoteDescription = faker.lorem.words(4)

  cy.get('#content')
    .clear()
    .type(updatedNoteDescription)
  cy.contains('button', 'Save').click()
  cy.wait('@getNotes')

  cy.contains('.list-group-item', noteDescription).should('not.exist')
  cy.contains('.list-group-item', updatedNoteDescription)
    .should('be.visible')
    .click()
  cy.wait('@getNote')
  cy.contains('button', 'Delete').click()
  cy.wait('@getNotes')

  cy.contains('.list-group-item', updatedNoteDescription).should('not.exist')
})
```

2. Execute o teste recÃ©m criado com o comando `npx cypress run --spec cypress/integration/crud.spec.js`

> **Obs.:** Siga adiante para o exercÃ­cio extra assim que o teste estiver passando.

## ExercÃ­cio extra 1 -  `cypress-file-upload`

VocÃª percebeu que alÃ©m de uma descriÃ§Ã£o, tambÃ©m Ã© possÃ­vel adicionar um anexo na criaÃ§Ã£o e ediÃ§Ã£o de uma anotaÃ§Ã£o?

Vamos testar essa funcionalidade tambÃ©m?

Pra isso, vamos precisar da ajuda da biblioteca [`cypress-file-upload`](https://www.npmjs.com/package/cypress-file-upload). ğŸ¦¸ğŸ½â€â™€ï¸

Seguem os passos necessÃ¡rios para adicionarmos esta possibilidade em nosso novo teste:

1. No terminal de linha de comando, na raiz do projeto, execute o comando `npm install cypress-file-upload@5.0.8 --save-dev` (ou `npm i cypress-file-upload@5.0.8 -D` para a versÃ£o curta)
2. No arquivo `cypress/support/index.js`, importe o `cypress-file-upload` (`import 'cypress-file-upload'`)
3. Agora, no arquivo `cypress/integration/crud.spec.js`, modifique-o para o seguinte:

```js
// cypress/integration/crud.spec.js

it('CRUDs a note', () => {
  const faker = require('faker')
  const noteDescription = faker.lorem.words(4)
  let attachFile = false

  cy.intercept('GET', '**/notes').as('getNotes')
  cy.intercept('GET', '**/notes/**').as('getNote')
  cy.login()

  cy.visit('/notes/new')
  cy.get('#content').type(noteDescription)

  if (attachFile) {
    cy.get('#file').attachFile('example.json')
  }

  cy.contains('button', 'Create').click()

  cy.wait('@getNotes')
  cy.contains('.list-group-item', noteDescription)
    .should('be.visible')
    .click()
  cy.wait('@getNote')

  const updatedNoteDescription = faker.lorem.words(4)

  cy.get('#content')
    .clear()
    .type(updatedNoteDescription)

  attachFile = true

  if (attachFile) {
    cy.get('#file').attachFile('example.json')
  }

  cy.contains('button', 'Save').click()
  cy.wait('@getNotes')

  cy.contains('.list-group-item', noteDescription).should('not.exist')
  cy.contains('.list-group-item', updatedNoteDescription)
    .should('be.visible')
    .click()
  cy.wait('@getNote')
  cy.contains('button', 'Delete').click()
  cy.wait('@getNotes')

  cy.contains('.list-group-item', updatedNoteDescription).should('not.exist')
})
```

4. Execute o teste recÃ©m refatorado com o comando `npx cypress run --spec cypress/integration/crud.spec.js`

> **Obs. 2:** Siga adiante para o prÃ³ximo exercÃ­cio extra assim que o teste estiver passando.

### ConteÃºdo relacionado ğŸ¤“

Recentemente criei um conteÃºdo sobre _upload_ de arquivos com Cypress e vou deixar aqui como material de consulta auxiliar: [Como fazer upload de arquivos com Cypress](https://talkingabouttesting.com/2021/04/15/como-fazer-upload-de-arquivos-com-cypress/).

## ExercÃ­cio extra 2 - movendo a lÃ³gica do CRUD para comandos customizados

Ufa! A principal funcionalidade da aplicaÃ§Ã£o estÃ¡ coberta por testes e2e. ğŸ˜…

PorÃ©m, o cÃ³digo ficou extenso, nÃ©?

Hora de movermos grande parte da lÃ³gica para alguns comandos customizados. Eles serÃ£o:

- `createNote` - Comando de criaÃ§Ã£o de uma anotaÃ§Ã£o
- `editNote` - Comando de atualizaÃ§Ã£o de uma anotaÃ§Ã£o
- `deleteNote` - Comando de deleÃ§Ã£o de uma anotaÃ§Ã£o

Siga os seguintes passos:

1. Atualize o arquivo `cypress/integration/crud.spec.js` pelo seguinte:

```js
// cypress/integration/crud.js

it('CRUDs a note', () => {
  const faker = require('faker')
  const noteDescription = faker.lorem.words(4)

  cy.intercept('GET', '**/notes').as('getNotes')
  cy.login()

  cy.createNote(noteDescription)
  cy.wait('@getNotes')

  const updatedNoteDescription = faker.lorem.words(4)
  const attachFile = true

  cy.editNote(noteDescription, updatedNoteDescription, attachFile)
  cy.wait('@getNotes')

  cy.deleteNote(updatedNoteDescription)
  cy.wait('@getNotes')
})
```

2. No arquivo `cypress/support/commands.js`, adicione os seguintes comandos customizados:

```js
// cypress/support/commands.js

// Outros comands aqui ...

const attachFileHandler = () => cy.get('#file').attachFile('example.json')

Cypress.Commands.add('createNote', (note, attachFile = false) => {
  cy.visit('/notes/new')
  cy.get('#content').type(note)

  if (attachFile) {
    attachFileHandler()
  }

  cy.contains('button', 'Create').click()

  cy.contains('.list-group-item', note).should('be.visible')
})

Cypress.Commands.add('editNote', (note, newValue, attachFile = false) => {
  cy.intercept('GET', '**/notes/**').as('getNote')

  cy.contains('.list-group-item', note).click()
  cy.wait('@getNote')

  cy.get('#content')
    .clear()
    .type(newValue)

  if (attachFile) {
    attachFileHandler()
  }

  cy.contains('button', 'Save').click()

  cy.contains('.list-group-item', note).should('not.exist')
  cy.contains('.list-group-item', newValue).should('be.visible')
})

Cypress.Commands.add('deleteNote', note => {
  cy.contains('.list-group-item', note).click()
  cy.contains('button', 'Delete').click()

  cy.contains('.list-group-item', note).should('not.exist')
})
```

3. Execute o teste recÃ©m refatorado com o comando `npx cypress run --spec cypress/integration/crud.spec.js`

> **Obs. 3:** Siga adiante para a prÃ³xima aula somente quando que o teste estiver passando. âŒ âœ…

___

Oba! Mais uma funcionalidade coberta por testes. ğŸ’–

VÃ¡ para a [aula 5](./5.md) e vamos testar um formulÃ¡rio de cartÃ£o de crÃ©dito que Ã© renderizado dentro de um iFrame. ğŸ–¼ï¸
