# Testando um formul√°rio de cart√£o de cr√©dito renderizado dentro de um iFrame üí≥

No mundo globalizado em que vivemos, compras online se tornaram algo comum em aplica√ß√µes web.

Na aplica√ß√£o **Scratch**, quando o(a) usu√°rio(a) est√° autenticado(a), este(a) pode simular uma compra utilizando cart√£o de cr√©dito, na p√°gina de _Settings_.

Por√©m, tal formul√°rio de cart√£o de cr√©dito √© rendereizado dentro de um iFrame, e atualmente, o Cypress n√£o suporta iFrames nativamente.

Oh, e agora, quem poder√° nos ajudar?

Te apresento a biblioteca [`cypress-iframe`](https://www.npmjs.com/package/cypress-iframe). ü¶∏üèº

## Exerc√≠cio

1. No terminal de linha de comando, na raiz do projeto, execute o comando `npm install cypress-iframe@1.0.1 --save-dev` (ou `npm i cypress-iframe@1.0.1 -D` para a vers√£o curta)
2. No arquivo `cypress/support/index.js`, importe o `cypress-iframe` (`import 'cypress-iframe'`)
3. No diret√≥rio `cypress/integration/`, renomeie o arquivo `authenticatedScenarios.spec.js` para `authenticatedScenarios.spec.js` e atualize seu conte√∫do para o seguinte:

```js
// authenticatedScenarios.spec.js

describe('Scenarios where authentication is a pre-requirement', () => {
  beforeEach(() => {
    cy.intercept('GET', '**/notes').as('getNotes')
    cy.login()
  })

  it('CRUDs a note', () => {
    const faker = require('faker')
    const noteDescription = faker.lorem.words(4)

    cy.createNote(noteDescription)
    cy.wait('@getNotes')

    const updatedNoteDescription = faker.lorem.words(4)
    const attachFile = true

    cy.editNote(noteDescription, updatedNoteDescription, attachFile)
    cy.wait('@getNotes')

    cy.deleteNote(updatedNoteDescription)
    cy.wait('@getNotes')
  })

  it.only('successfully submits the form', () => {
    cy.intercept('POST', '**/prod/billing').as('paymentRequest')

    cy.fillSettingsFormAndSubmit()

    cy.wait('@getNotes')
    cy.wait('@paymentRequest').then(response => {
      expect(response.state).to.equal('Complete')
    })
  })
})
```

4. Adicione ao arquivo `cypress/support/commands.js` o comando `fillSettingsFormAndSubmit`, conforme o c√≥digo abaixo:

```js
// cypress/support/commands.js

// Outros comandos aqui ...

Cypress.Commands.add('fillSettingsFormAndSubmit', () => {
  cy.visit('/settings')
  cy.get('#storage').type('1')
  cy.get('#name').type('Mary Doe')
  cy.iframe('.card-field iframe')
    .as('iframe')
    .find('[name="cardnumber"]')
    .type('4242424242424242')
  cy.get('@iframe')
    .find('[name="exp-date"]')
    .type('1271')
  cy.get('@iframe')
    .find('[name="cvc"]')
    .type('123')
  cy.get('@iframe')
    .find('[name="postal"]')
    .type('12345')
  cy.contains('button', 'Purchase').click()
})
```

5. No arquivo `cypress.json`, adicione a seguinte configura√ß√£o `"chromeWebSecurity": false,`

6. Execute o teste rec√©m criado com o comando `npx cypress run --spec cypress/integration/authenticatedScenarios.spec.js`

> **Obs.:** Siga para a pr√≥xima se√ß√£o assim que o teste estiver passando.
>
> **Obs. 2:** N√£o esque√ßa de remover o `.only` do novo teste. üòâ

## Limita√ß√µes

Conforme comentado no in√≠cio desta aula, atualmente o Cypress n√£o suporta iFrames nativamente.

Na documenta√ß√£o oficial da ferramenta isso √© comentado, na se√ß√£o de [_Temporary trade-offs_](https://docs.cypress.io/guides/references/trade-offs#Temporary-trade-offs).

Dada esta limita√ß√£o, a funcionalidade de _time travel_ n√£o funciona em elementos renderizados dentro de iFrames, quando executando testes em modo interativo, mesmo usando a biblioteca `cypress-iframe`.

Caso queira acompanhar a evolu√ß√£o do Cypress com rela√ß√£o a esta limita√ß√£o, recomendo acionar as notifica√ß√µes para [esta _issue_](https://github.com/cypress-io/cypress/issues/136) no projeto do Cypress no GitHub.

## _Roadmap_

Apesar da limita√ß√£o, o Cypress menciona em seu [_Roadmap_](https://docs.cypress.io/guides/references/roadmap) que o suporte para iFrames ser√° adicionado no futuro. ü™Ö

## Conte√∫do relacionado ü§ì

Recentemente criei um conte√∫do sobre intera√ß√£o com elementos renderizados dentro de iFrames com Cypress e vou deixar aqui como material de consulta auxiliar: [Lidando com iFrames com Cypress](https://youtu.be/sjiLhjPxYvs).

___

V√° para a [aula 6](./6.md) e vamos testar o _Logout_ utilizando o **_Cypress Studio_**.
